// prisma/schema.prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id        String     @id @default(cuid())
  email     String     @unique
  name      String?
  role      String     @default("user")
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  workspaces Workspace[]
  agents     Agent[]
}

model Workspace {
  id        String     @id @default(cuid())
  name      String
  userId    String
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  intake            WorkspaceIntake?
  agents            Agent[]
  repositoryItems   RepositoryItem[]
  threads           Thread[]
  intakeForms       IntakeForm[]

  @@index([userId])
}

model WorkspaceIntake {
  id           String   @id @default(cuid())
  workspaceId  String   @unique
  workspace    Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  department   String?
  industry     String?
  companySize  String?
  goal         String?
  challenges   String?
  resources    String?
  timeline     String?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model IntakeForm {
  id           String   @id @default(cuid())
  workspaceId  String
  workspace    Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  companyName  String
  contactEmail String
  contactPhone String?
  department   String
  industry     String
  companySize  String
  currentState String?
  mainGoals    String[]
  challenges   String[]
  resources    String?
  timeline     String?
  budget       String?
  status       String   @default("draft")
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([workspaceId])
}

model Agent {
  id              String   @id @default(cuid())
  workspaceId     String
  workspace       Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name            String
  role            String
  department_name String
  description     String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  threads         Thread[]

  @@index([workspaceId])
  @@index([userId])
}

model Thread {
  id          String   @id @default(cuid())
  agentId     String
  agent       Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  title       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  messages    Message[]

  @@index([agentId])
  @@index([workspaceId])
}

model Message {
  id        String   @id @default(cuid())
  threadId  String
  thread    Thread   @relation(fields: [threadId], references: [id], onDelete: Cascade)
  
  role      String   // "user" or "assistant"
  content   String   @db.Text
  createdAt DateTime @default(now())

  @@index([threadId])
}

model RepositoryItem {
  id          String   @id @default(cuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  title       String
  content     String   @db.Text
  type        String   // "document", "code", "knowledge", etc.
  pinned      Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([workspaceId])
}
